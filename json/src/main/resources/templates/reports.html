<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Отчеты</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { padding-top: 4.5rem; background: #f8f9fa; }
        .form-select, .form-control { margin-bottom: 1rem; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow">
    <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="/view/enterprises">← Назад</a>
        <span class="navbar-text text-white ms-3">Отчеты</span>
        <button class="btn btn-outline-light ms-auto" id="logoutBtn">Выход</button>
    </div>
</nav>

<div class="container mt-4" style="max-width: 600px;">
    <div class="card shadow-sm rounded-4 p-4">
        <h5 class="mb-3">Сформировать отчет</h5>

        <label for="reportSelect" class="form-label">Тип отчета</label>
        <select id="reportSelect" class="form-select" required></select>

        <label for="dateFrom" class="form-label">Дата с</label>
        <input type="date" id="dateFrom" class="form-control" required>

        <label for="dateTo" class="form-label">Дата по</label>
        <input type="date" id="dateTo" class="form-control" required>

        <label for="intervalSelect" class="form-label">Интервал</label>
        <select id="intervalSelect" class="form-select" required>
            <option value="day">День</option>
            <option value="month">Месяц</option>
            <option value="year">Год</option>
        </select>

        <div id="enterpriseContainer" class="d-none">
            <label for="enterpriseSelect" class="form-label">Предприятие</label>
            <select id="enterpriseSelect" class="form-select"></select>
        </div>

        <div id="vehicleContainer" class="d-none">
            <label for="vehicleSelect" class="form-label">Автомобиль</label>
            <select id="vehicleSelect" class="form-select"></select>
        </div>

        <button class="btn btn-primary w-100" id="generateBtn">Сформировать</button>
    </div>

    <hr class="my-4">

    <div id="reportResult" class="mt-4 d-none">
        <h5>Результат отчета</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th id="intervalHeader">Интервал</th>
                    <th>Значение</th>
                </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="d-grid mt-3 d-none" id="downloadContainer">
        <button class="btn btn-outline-secondary" id="downloadBtn">Скачать отчет</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const token = localStorage.getItem('access_token');
    if (!token) location.href = '/login';

    const reportSelect = document.getElementById('reportSelect');
    const reportMap = new Map();

    const enterpriseSelect = document.getElementById('enterpriseSelect');
    const vehicleSelect = document.getElementById('vehicleSelect');
    const enterpriseContainer = document.getElementById('enterpriseContainer');
    const vehicleContainer = document.getElementById('vehicleContainer');

    let lastGeneratedReport = null;

    async function loadReports() {
        try {
            const res = await fetch('/api/v1/reports', {
                headers: { Authorization: `Bearer ${token}` }
            });
            const reports = await res.json();

            reports.forEach(r => {
                reportMap.set(r.name, r.requestValue);
                reportSelect.add(new Option(r.name, r.name));
            });
        } catch (err) {
            console.error(err);
            alert('Не удалось загрузить список отчетов');
        }
    }

    async function loadEnterprises() {
        try {
            const res = await fetch('/api/v1/enterprises', {
                headers: { Authorization: `Bearer ${token}` }
            });
            const enterprises = await res.json();
            enterpriseSelect.innerHTML = '';
            enterprises.forEach(ent => {
                enterpriseSelect.add(new Option(ent.name, ent.id));
            });
        } catch (err) {
            console.error(err);
            alert('Не удалось загрузить предприятия');
        }
    }

    async function loadVehicles(enterpriseId) {
        try {
            const res = await fetch(`/api/v1/vehicles/by_enterprise?enterprise_id=${enterpriseId}`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const vehicles = await res.json();
            vehicleSelect.innerHTML = '';
            vehicles.forEach(v => {
                vehicleSelect.add(new Option(v.carNumber, v.id));
            });
        } catch (err) {
            console.error(err);
            alert('Не удалось загрузить автомобили');
        }
    }

    reportSelect.addEventListener('change', async () => {
        const name = reportSelect.value;
        const requestValue = reportMap.get(name);
        const needsVehicle = requestValue === 'mileage';

        if (needsVehicle) {
            enterpriseContainer.classList.remove('d-none');
            vehicleContainer.classList.remove('d-none');
            await loadEnterprises();
            const firstEnterprise = enterpriseSelect.value;
            if (firstEnterprise) await loadVehicles(firstEnterprise);
        } else {
            enterpriseContainer.classList.add('d-none');
            vehicleContainer.classList.add('d-none');
        }
    });

    enterpriseSelect.addEventListener('change', () => {
        const id = enterpriseSelect.value;
        if (id) loadVehicles(id);
    });

    document.getElementById('generateBtn').addEventListener('click', async () => {
        const reportName = reportSelect.value;
        const requestValue = reportMap.get(reportName);

        if (!requestValue) {
            alert('Выберите тип отчета');
            return;
        }

        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const interval = document.getElementById('intervalSelect').value;

        if (!dateFrom || !dateTo) {
            alert('Заполните даты');
            return;
        }

        const payload = {
            type: requestValue,
            date_from: dateFrom,
            date_to: dateTo,
            interval: interval
        };

        if (requestValue === 'mileage') {
            const vehicleId = vehicleSelect.value;
            if (!vehicleId) {
                alert('Выберите автомобиль');
                return;
            }
            payload.vehicleId = vehicleId;
        }

        try {
            const response = await fetch('/api/v1/reports/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Ошибка при генерации отчета');

            const result = await response.json();
            lastGeneratedReport = result;

            const intervalNames = { day: 'День', month: 'Месяц', year: 'Год' };

            const tableBody = document.getElementById('reportTableBody');
            const intervalHeader = document.getElementById('intervalHeader');
            const resultDiv = document.getElementById('reportResult');

            intervalHeader.textContent = intervalNames[result.interval] || 'Интервал';
            tableBody.innerHTML = '';

            Object.entries(result.result).forEach(([key, value]) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${key}</td><td>${value}</td>`;
                tableBody.appendChild(row);
            });

            resultDiv.classList.remove('d-none');
            document.getElementById('downloadContainer').classList.remove('d-none');

        } catch (err) {
            console.error(err);
            alert('Не удалось сгенерировать отчет');
        }
    });

    document.getElementById('downloadBtn').addEventListener('click', async () => {
        if (!lastGeneratedReport) {
            alert('Отчет еще не сформирован');
            return;
        }

        try {
            const response = await fetch('/api/v1/reports/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                },
                body: JSON.stringify(lastGeneratedReport)
            });

            if (!response.ok) throw new Error('Ошибка при скачивании');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

        } catch (err) {
            console.error(err);
            alert('Ошибка при скачивании отчета');
        }
    });

    document.getElementById('logoutBtn').onclick = () => {
        localStorage.clear();
        location.href = '/login';
    };

    loadReports();
</script>
</body>
</html>
